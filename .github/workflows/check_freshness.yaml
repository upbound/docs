name: Documentation Freshness Check
on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  check_freshness:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Create scripts directory
      run: mkdir -p .github/scripts
        
    - name: Copy Python script
      run: |
        cat > .github/scripts/check_freshness.py << 'EOL'
        import os
        import subprocess
        from datetime import datetime, timedelta

        FRESHNESS_PERIOD = timedelta(days=180)
        IGNORED_FILES = ["_index.md", "support.md"]
        now = datetime.now()

        def get_last_modified_time(file_path):
            result = subprocess.run(
                ['git', 'log', '-1', '--format=%ct', file_path],
                stdout=subprocess.PIPE,
                text=True
            )
            timestamp = int(result.stdout.strip())
            return datetime.fromtimestamp(timestamp)

        def check_freshness(directory):
            stale_files = []
            for root, _, files in os.walk(directory):
                for file in files:
                    if file.endswith(".md"):
                        relative_path = os.path.relpath(os.path.join(root, file), start=directory)
                        if file in IGNORED_FILES:
                            continue
                        last_modified = get_last_modified_time(os.path.join(root, file))
                        time_diff = now - last_modified
                        if time_diff > FRESHNESS_PERIOD:
                            stale_files.append((relative_path, last_modified))
            return stale_files

        docs_directory = "content"
        stale_docs = check_freshness(docs_directory)
        sorted_stale_docs = sorted(stale_docs, key=lambda x: x[1])

        if sorted_stale_docs:
            print("The following docs have not been modified for at least 6 months:")
            for doc, mod_time in sorted_stale_docs:
                print(f"{doc}, {mod_time.strftime('%Y-%m-%d')}")
        else:
            print("All documents are fresh!")
        EOL

    - name: Run freshness check
      id: check
      run: |
        python3 .github/scripts/check_freshness.py > stale_docs.txt
        if [ -s stale_docs.txt ]; then
          thread_message=$(cat stale_docs.txt | sed 's/"/\\"/g' | tr '\n' ' ' | sed 's/\\n/ /g')
          echo "THREAD_MESSAGE=${thread_message}" >> $GITHUB_ENV
          echo "HAS_STALE=true" >> $GITHUB_ENV
        else
          echo "HAS_STALE=false" >> $GITHUB_ENV
        fi

    - name: Post initial message
      id: slack
      uses: slackapi/slack-github-action@v1.24.0
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      with:
        channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
        payload: |
          {
            "text": "Documentation Freshness Check Results"
          }

    - name: Post thread reply
      if: env.HAS_STALE == 'true'
      uses: slackapi/slack-github-action@v1.24.0
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      with:
        channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
        payload: |
          {
            "thread_ts": "${{ fromJSON(steps.slack.outputs.response).ts }}",
            "text": ":warning: ${{ env.THREAD_MESSAGE }}"
          }
