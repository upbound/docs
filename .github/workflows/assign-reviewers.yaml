name: Assign Reviewer Based on Label

on:
  pull_request:
    types:
      - opened

jobs:
  assign-reviewer:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Read Reviewer Mapping File
        id: load-mapping
        run: |
          reviewers_yaml=$(cat .github/reviewer-mapping.yml)
          echo "reviewers_yaml<<EOF" >> $GITHUB_ENV
          echo "$reviewers_yaml" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Get PR labels
        id: get-labels
        run: |
          labels_json=${{ toJson(github.event.pull_request.labels) }}
          echo "PR labels: $labels_json"
          echo "labels=$labels_json" >> $GITHUB_ENV

      - name: Determine Reviewer
        id: assign
        run: |
          import yaml
          import os
          import json

          # Load label-to-reviewer mapping from YAML file
          mapping = yaml.safe_load(os.getenv("reviewers_yaml"))

          # Load labels from GitHub event
          labels = json.loads(os.getenv("labels"))

          # Extract label names
          label_names = [label["name"] for label in labels]

          # Find the first matching reviewer
          assigned_reviewer = mapping.get("default", ["tr0njavolta"])[0]  # Docs as default reviewer
          for label in label_names:
              if label in mapping:
                  assigned_reviewer = mapping[label][0]
                  break

          print(f"Assigned reviewer: {assigned_reviewer}")
          with open(os.getenv("GITHUB_ENV"), "a") as env_file:
              env_file.write(f"reviewer={assigned_reviewer}\n")

        shell: python

      - name: Assign Reviewer
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              reviewers: [process.env.reviewer]
            })
