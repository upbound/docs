{{ $spaceAPI := .Site.GetPage "space-api" }}
{{ $versionList := slice }}
{{ $majordict := dict }}
{{ $majorlist := slice }}
{{ $sorted_list := slice }}
{{ $cur_ver := .Page.Params.version | default .Site.Params.latest }}

<!-- Get all the versions and break out semver order -->
{{ range $spaceAPI.Pages }}
  {{ if eq .Params.version "main" }}
    {{ $sorted_list = $sorted_list | append "main" }}
  {{ else if ne .Params.version nil }}
    {{ $splitver := split .Params.version "." }}
    {{ if eq (len $splitver) 2 }}
      {{ $majorver := index $splitver 0 }}
      {{ $minorver := index $splitver 1 }}
      {{ $verlist := index $majordict $majorver | default slice }}
      {{ $verlist = $verlist | append $minorver }}
      {{ $majordict = merge $majordict (dict $majorver $verlist) }}
      {{ $majorlist = $majorlist | append $majorver }}
    {{ end }}
  {{ end }}
{{ end }}

{{ range sort ($majorlist | uniq) "value" "desc" }}
  {{ $majorver := . }}
  {{ range sort (index $majordict .) "value" "desc" }}
    {{ $sorted_list = $sorted_list | append (printf "%s.%s" $majorver .) }}
  {{ end }}
{{ end }}

<div class="dropdown float-end bd-dropdown">
    <a class="btn btn-outline-secondary dropdown-toggle bd-dropdown-item text-reset" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        {{ if ne .Page.Params.version "latest" }}{{ end }}{{ $cur_ver }}
        {{ if eq $cur_ver .Site.Params.latest }}
        <div class="badge rounded-pill latest">Latest</div>
        {{ end }}
    </a>

    <div class="dropdown-menu bd-border-color bd-dropdown" aria-labelledby="dropdownMenuLink">
        {{ $latest_url := replaceRE "v[0-9].[0-9]" "latest" .Permalink }}
        {{/*  Iterate over the ordered list of available versions. */}}
        {{ range $sorted_list }}
            {{ $matchingTitle := $.Title }}
            {{ if $.Params.matchTitle }}
                {{ $matchingTitle = $.Params.matchTitle }}
            {{ end }}
            {{/*  For a version, see if there is a page with an identical title to the page we're on. If not use the page at /content/v<version>  */}}
            {{ $versionPage :=  index (where (where $.Site.Pages "Title" $matchingTitle) ".Page.Params.version" .) 0 | default ($.Site.GetPage (printf "v%s" .)) }}
            {{/*  If the version is latest get the latest page since "vlatest" doesn't exist  */}}
            {{ if not $versionPage }}
                {{ $versionPage = $.Site.GetPage "latest" }}
            {{ end }}
                {{ with $versionPage }}
                    {{ $isLatest := false }}
                    {{ if or (eq .Page.Params.version "") (eq .Page.Params.version $cur_ver) }}
                        {{ $isLatest = true }}
                    {{ end }}
                    <a class="dropdown-item bd-dropdown-item {{- if $isLatest }} active {{- end}}" {{- if $isLatest }}aria-current="true"{{end}} href="{{ .Permalink }}">
                        {{ if eq .Page.Params.version "latest" }}
                            latest
                        {{ else }}
                            {{ if eq .Page.Params.version "" }}
                                {{ (printf "%s" .Site.Params.latest) }}
                            {{ else }}
                                {{ (printf "%s" .Page.Params.version) }}
                            {{ end }}
                        {{ end }}
                        {{ if or (eq .Page.Params.version .Site.Params.latest) (eq .Page.Params.version "") }}
                        <div class="badge rounded-pill latest">Latest</div>
                        {{ end }}
                    </a>
                {{ end }}
            {{ end }}
    </div>
</div>
